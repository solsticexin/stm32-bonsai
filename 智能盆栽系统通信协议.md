# 智能盆栽系统通信协议

## 1. 协议概述

本协议定义 **STM32F103 主控板** 与 **ESP-01S Wi-Fi 模块** 之间的数据链路，用于把现场传感数据上传至网页端并接收远程控制指令。通信通道为 **UART（115 200 bps，8N1，无硬件流控）**，上层载荷采用 **NDJSON（Newline-Delimited JSON）** 文本格式：每条消息是一行 UTF-8 字符串，以 `\n` 作为帧结束符。

## 2. 角色与职责

| 角色        | 说明 | 职责 |
|-------------|------|------|
| STM32 节点   | 采集温湿度、光照、土壤湿度等数据，驱动执行机构 | 周期性上报 `data`，执行来自 ESP 的指令并返回 `ack` |
| ESP-01S 网关 | 串口转 Wi-Fi，桥接网页端 | 透传 STM32 消息给网页端，转发网页命令到 STM32 |
| Web 前端    | 展示仪表盘、发起控制 | 生成 `cmd` 消息并通过 ESP 下发 |

## 3. 报文类型总览

| `type` | 方向                         | 用途           |
|--------|------------------------------|----------------|
| `data` | STM32 → ESP → Web            | 上传遥测数据   |
| `cmd`  | Web → ESP → STM32            | 请求执行动作   |
| `ack`  | STM32 → ESP → Web            | 返回执行结果   |

所有报文必须包含 `type` 字段；额外字段详见下文。解析方应忽略未知字段，以便向后兼容。

## 4. 数据上报帧（`type: "data"`）

```json
{
  "type": "data",
  "temp": 25.3,
  "humi": 61.2,
  "soil": 48,
  "lux": 345.6,
  "water": 0,
  "light": 1,
  "fan": 0,
  "buzzer": 0
}
```

字段说明：

| 字段     | 类型        | 单位 / 取值范围 | 说明 |
|----------|-------------|-----------------|------|
| `temp`   | number/null | ℃，保留 1 位小数 | 环境温度；读取失败填 `null` |
| `humi`   | number/null | %，保留 1 位小数 | 相对湿度；读取失败填 `null` |
| `soil`   | number/null | %，0–100         | 土壤含水量；读取失败填 `null` |
| `lux`    | number/null | lx，保留 1 位小数 | 光照强度；读取失败填 `null` |
| `water`  | integer     | 0 / 1            | 水泵继电器当前状态 |
| `light`  | integer     | 0 / 1            | 补光灯状态 |
| `fan`    | integer     | 0 / 1            | 风扇状态 |
| `buzzer` | integer     | 0 / 1            | 蜂鸣器状态 |

## 5. 控制命令帧（`type: "cmd"`）

```json
{
  "type": "cmd",
  "target": "light",
  "action": "on",
  "time": 500
}
```

字段定义：

| 字段     | 类型    | 取值                   | 说明 |
|----------|---------|------------------------|------|
| `target` | string  | `"water"`, `"light"`, `"fan"`, `"buzzer"` | 指定被控执行机构 |
| `action` | string  | `"on"`, `"off"`, `"pulse"`               | 控制动作 |
| `time`   | integer | 1–10 000（毫秒，可选）                  | 仅在 `"pulse"` 时必填 |

示例：
- 常开补光灯：`{"type":"cmd","target":"light","action":"on"}`
- 蜂鸣 0.5 秒：`{"type":"cmd","target":"buzzer","action":"pulse","time":500}`

若缺少必填字段，STM32 必须忽略该命令并记录错误。

## 6. 执行回执帧（`type: "ack"`）

```json
{
  "type": "ack",
  "target": "light",
  "action": "on",
  "result": "ok",
  "message": "already on"
}
```

字段定义：

| 字段     | 类型   | 取值                   | 说明 |
|----------|--------|------------------------|------|
| `target` | string | 参考 `cmd.target`       | 回执对应的执行对象 |
| `action` | string | 参考 `cmd.action`       | 回执对应的动作 |
| `result` | string | `"ok"` / `"error"`      | 指令执行结果 |
| `message`| string | 可选                    | 失败原因或提示（如设备已在目标状态） |

## 7. 流程时序

1. **上报**：STM32 每 5 秒读取传感器，调用 `data` 帧上报。ESP 立即透传至网页，网页刷新仪表盘。
2. **控制**：用户在网页触发操作 → 前端构造 `cmd` 帧 → 通过 ESP 转发到 STM32。
3. **确认**：STM32 完成控制逻辑后生成 `ack` 帧，并附带状态信息 → ESP → 网页显示执行结果。

## 8. 可靠性约定

- STM32 端发送失败时必须重试或在调试串口输出错误日志。
- ESP 端在检测到非法 JSON 时应丢弃该帧，不得转发。
- 任意一端若收到未知 `type`，必须忽略该帧并保持连接。
- 所有 JSON 字段名称区分大小写；布尔量使用 `0/1` 以兼容固件实现。

## 9. 版本演进

- `v1.0`（当前版本）：包含 `data` / `cmd` / `ack` 三种帧，支持水泵、补光灯、风扇、蜂鸣器四类执行机构。
- 后续扩展可新增字段或 `target`，保持向后兼容即可；旧固件需忽略无法识别的部分。
